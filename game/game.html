<html>
	<head>
		<script src="http://code.createjs.com/createjs-2013.12.12.min.js"></script>
		<script src="./Player.js"></script>
		<script src="./Tube.js"></script>
		<script>
			//constants
			var PLANET_SIZE = 150;
			var PLANET_OFFSET = 10;
			var TUBE_OFFSET = 6;
			var TUBE_W = 33;
			var TUBE_H = 69;
			var TURN_FACTOR = 7;	//how far the ship turns per frame
			var BULLET_SPEED = 17;	//how fast the bullets move
			var BULLET_TIME = 5;		//ticks between bullets
			var BULLET_ENTROPY = 100;	//how much energy a bullet has before it runs out.

			//keycodes
			var KEYCODE_ENTER = 13;		
			var KEYCODE_SPACE = 32;		
			var KEYCODE_UP = 38;		
			var KEYCODE_LEFT = 37;		
			var KEYCODE_RIGHT = 39;		
			var KEYCODE_W = 87;			
			var KEYCODE_A = 65;			
			var KEYCODE_D = 68;			

			//keys hold
			var shootHeld;
			var lfHeld;	
			var rtHeld;	
			var fwdHeld;

			var nextBullet;			//ticks left until the next shot is fired

			var bulletStream;		//bullet array

			//game classes
			var player;			//player ship
			var deadPlanet;
			var targetPlanet;
			var array_tube;		//tube
			var alive;

			//sprites
			var img_planet;
			var img_tube;
			var ss_planet;
			var ss_tube;

			//work classes
			var canvas;
			var stage;
			var message;
			var loader;
			
			document.onkeydown = handleKeyDown;
			document.onkeyup = handleKeyUp;
			
			function init() 
			{
				document.getElementById("mobile").style.display = "none";
				document.getElementById("error").style.display = "none";

				if (!createjs.Sound.initializeDefaultPlugins()) 
				{
					document.getElementById("error").style.display = "block";
					document.getElementById("content").style.display = "none";
					return;
				}

				if (createjs.Sound.BrowserDetect.isIOS || createjs.Sound.BrowserDetect.isAndroid || createjs.Sound.BrowserDetect.isBlackberry)
				{
					document.getElementById("mobile").style.display = "block";
					document.getElementById("content").style.display = "none";
					return;
				}

				canvas = document.getElementById("worlds");
				stage = new createjs.Stage(canvas);

				/*message = new createjs.Text("Loading", "bold 24px Arial", "#FFFFFF");
				message.maxWidth = 1000;
				message.textAlign = "center";
				message.x = canvas.width / 2;
				message.y = canvas.height / 2;
				stage.addChild(message);
				stage.update();*/

				manifest = [
					{src:"./img/planet.png", id:"planet"},
					{src:"./img/tube.png", id:"tube"}
				];

				loader = new createjs.LoadQueue(false);
				loader.addEventListener("complete", handleComplete);
				loader.loadManifest(manifest);
			}

			function handleComplete(event)
			{
				img_planet = loader.getResult("planet");
				img_tube = loader.getResult("tube");

				player = new Player();
				player.x = 50;
				player.y = 50;

				ss_planet = new createjs.SpriteSheet({
					images: [img_planet],
					frames: { width: PLANET_SIZE, height: PLANET_SIZE },
					animations: { alive: [0], dead: [1] }	//TODO add "change"
				});

				ss_tube = new createjs.SpriteSheet({
					images: [img_tube],
					frames: { width: TUBE_W, height: TUBE_H },
					animations: { begin: [0], end: [3], free: [1], busy: [2] }
				});

				deadPlanet = new createjs.Sprite(ss_planet, "dead");
				deadPlanet.x = PLANET_OFFSET;
				deadPlanet.y = canvas.height/2 - PLANET_SIZE/2;

				targetPlanet = new createjs.Sprite(ss_planet, "alive");
				targetPlanet.x = canvas.width - (PLANET_SIZE + PLANET_OFFSET);
				targetPlanet.y = canvas.height/2 - PLANET_SIZE/2;

				array_tube = new Array(10);
				array_tube[0] = new createjs.Sprite(ss_tube, "begin");
				array_tube[0].x = PLANET_OFFSET + PLANET_SIZE - TUBE_OFFSET;
				array_tube[0].y = canvas.height/2 - TUBE_H/2;
				array_tube[14] = new createjs.Sprite(ss_tube, "end");
				array_tube[14].x = canvas.width - (TUBE_W + PLANET_OFFSET + PLANET_SIZE - TUBE_OFFSET);
				array_tube[14].y = canvas.height/2 - TUBE_H/2;

				for(var i = 1; i < 14; ++i)
				{
					array_tube[i] = new createjs.Sprite(ss_tube, "free");
					array_tube[i].x = PLANET_OFFSET + PLANET_SIZE - TUBE_OFFSET + TUBE_W*i;
					array_tube[i].y = canvas.height/2 - TUBE_H/2;
					stage.addChild(array_tube[i]);
				}

				stage.addChild(deadPlanet);
				stage.addChild(targetPlanet);
				stage.addChild(array_tube[0]);
				stage.addChild(array_tube[14]);
				stage.addChild(player);
				stage.update();

				bulletStream = [];
				alive = true;
				nextBullet = 0;

				if(!createjs.Ticker.hasEventListener("tick"))
				{ 
					createjs.Ticker.addEventListener("tick", tick);
				}
			}

			function tick(event) 
			{
				//handle firing
				if(nextBullet <= 0)
				{
					if(alive && shootHeld)
					{
						nextBullet = BULLET_TIME;
						fireBullet();
					}
				}
				else
				{
					nextBullet--;
				}

				//handle turning
				if(alive && lfHeld)
				{
					player.rotation -= TURN_FACTOR;
				}
				else if(alive && rtHeld)
				{
					player.rotation += TURN_FACTOR;
				}

				//handle thrust
				if(alive && fwdHeld)
				{
					player.accelerate();
				}

				//handle new spaceRocks
				/*if(nextRock <= 0)
				{
					if(alive)
					{
						timeToRock -= DIFFICULTY;	//reduce spaceRock spacing slowly to increase difficulty with time
						var index = getSpaceRock(SpaceRock.LRG_ROCK);
						rockBelt[index].floatOnScreen(canvas.width, canvas.height);
						nextRock = timeToRock + timeToRock*Math.random();
					}
				}
				else
				{
					nextRock--;
				}*/

				//handle player looping
				/*if(alive && outOfBounds(player, player.bounds))
				{
					placeInBounds(player, player.bounds);
				}*/

				//handle bullet movement and looping
				for(bullet in bulletStream)
				{
					var o = bulletStream[bullet];
					if(!o || !o.active) { continue; }
					if(outOfBounds(o, player.bounds))
					{
						stage.removeChild(o);
						bulletStream[bullet].active = false;
					}
					o.x += Math.sin(o.rotation*(Math.PI/-180))*BULLET_SPEED;
					o.y += Math.cos(o.rotation*(Math.PI/-180))*BULLET_SPEED;

					if(--o.entropy <= 0)
					{
						stage.removeChild(o);
						o.active = false;
					}
				}

				//handle spaceRocks (nested in one loop to prevent excess loops)
				/*for(spaceRock in rockBelt)
				{
					var o = rockBelt[spaceRock];
					if(!o || !o.active) { continue; }

					//handle spaceRock movement and looping
					if(outOfBounds(o, o.bounds))
					{
						placeInBounds(o, o.bounds);
					}
					o.tick(event);


					//handle spaceRock player collisions
					if(alive && o.hitRadius(player.x, player.y, player.hit))
					{
						alive = false;

						stage.removeChild(player);
						messageField.text = "You're dead:  Click or hit enter to play again";
						stage.addChild(messageField);
						watchRestart();

						//play death sound
						createjs.Sound.play("death", createjs.Sound.INTERRUPT_ANY);
						continue;
					}

					//handle spaceRock bullet collisions
					for(bullet in bulletStream) {
						var p = bulletStream[bullet];
						if(!p || !p.active) { continue; }

						if(o.hitPoint(p.x, p.y)) {
							var newSize;
							switch(o.size) {
								case SpaceRock.LRG_ROCK: newSize = SpaceRock.MED_ROCK;
									break;
								case SpaceRock.MED_ROCK: newSize = SpaceRock.SML_ROCK;
									break;
								case SpaceRock.SML_ROCK: newSize = 0;
									break;
							}

							//score
							if(alive) {
								addScore(o.score);
							}

							//create more
							if(newSize > 0) {
								var i;
								var index;
								var offSet;

								for(i=0; i < SUB_ROCK_COUNT; i++){
									index = getSpaceRock(newSize);
									offSet = (Math.random() * o.size*2) - o.size;
									rockBelt[index].x = o.x + offSet;
									rockBelt[index].y = o.y + offSet;
								}
							}

							//remove
							stage.removeChild(o);
							rockBelt[spaceRock].active = false;

							stage.removeChild(p);
							bulletStream[bullet].active = false;

							// play sound
							createjs.Sound.play("break", createjs.Sound.INTERUPT_LATE, 0, 0.8);
						}
					}
				}*/

				//call sub ticks
				player.tick(event);
				stage.update(event);
			}

			function fireBullet()
			{
				//create the bullet
				var o = bulletStream[getBullet()];
				o.x = player.x;
				o.y = player.y;
				o.rotation = player.rotation;
				o.entropy = BULLET_ENTROPY;
				o.active = true;

				//draw the bullet
				o.graphics.beginStroke("#FFFFFF").moveTo(-1, 0).lineTo(1, 0);

				// play the shot sound
				//createjs.Sound.play("laser", createjs.Sound.INTERUPT_LATE);
			}

			function getBullet()
			{
				var i = 0;
				var len = bulletStream.length;

				//pooling approach
				while(i <= len)
				{
					if(!bulletStream[i])
					{
						bulletStream[i] = new createjs.Shape();
						break;
					}
					else if(!bulletStream[i].active)
					{
						bulletStream[i].active = true;
						break;
					}
					else
					{
						i++;
					}
				}

				if(len == 0)
				{
					bulletStream[0] = new createjs.Shape();
				}

				stage.addChild(bulletStream[i]);
				return i;
			}

			function handleKeyDown(e)
			{
				//cross browser issues exist
				if(!e){ var e = window.event; }
				switch(e.keyCode)
				{
					case KEYCODE_SPACE:	shootHeld = true; return false;
					case KEYCODE_A:
					case KEYCODE_LEFT:	lfHeld = true; return false;
					case KEYCODE_D:
					case KEYCODE_RIGHT: rtHeld = true; return false;
					case KEYCODE_W:
					case KEYCODE_UP:	fwdHeld = true; return false;
					case KEYCODE_ENTER:	 if(canvas.onclick == handleClick){ handleClick(); }return false;
				}
			}

			function handleKeyUp(e)
			{
				//cross browser issues exist
				if(!e) { var e = window.event; }
				switch(e.keyCode)
				{
					case KEYCODE_SPACE:	shootHeld = false; break;
					case KEYCODE_A:
					case KEYCODE_LEFT:	lfHeld = false; break;
					case KEYCODE_D:
					case KEYCODE_RIGHT: rtHeld = false; break;
					case KEYCODE_W:
					case KEYCODE_UP:	fwdHeld = false; break;
				}
			}

			function outOfBounds(o, bounds)
			{
				//is it visibly off screen
				return o.x < bounds*-2 || o.y < bounds*-2 || o.x > canvas.width+bounds*2 || o.y > canvas.height+bounds*2;
			}
		</script>
		<style type="text/css">
			#content {
				user-select: none;
				background-color:#000000;
				width: 800px;
				height: 600px;
			}
		</style>
	</head>
	<body onLoad="init();">
		<div id="content">
			<canvas id="worlds" width="800" height="600"></canvas>
		</div>

		<!-- TODO make links! -->
		<div id="error">
			<h1>Oops!</h1>
			<p>SoundJS is not currently supported in your browser. Try to use Chrome.</p>
		</div>

		<div id="mobile">
			<h1>Oops!</h1>
			<p>Mobile devices isn't supported...</p>
		</div>
	</body>
</html>