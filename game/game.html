<html>
	<head>
		<script src="http://code.createjs.com/createjs-2013.12.12.min.js"></script>
		<script src="./Player.js"></script>
		<script src="./Tube.js"></script>
		<script>
			//constants
			var PLANET_SIZE = 150;
			var PLANET_OFFSET = 10;
			var TUBE_OFFSET = 6;
			var TUBE_W = 33;
			var TUBE_H = 69;

			//game classes
			var player;			//player ship
			var deadPlanet;
			var targetPlanet;
			var array_tube;		//tube

			//sprites
			var img_planet;
			var img_tube;
			var ss_planet;
			var ss_tube;

			//work classes
			var canvas;
			var stage;
			var message;
			var loader;
			
			//document.onkeydown = handleKeyDown;
			//document.onkeyup = handleKeyUp;
			
			function init() 
			{
				document.getElementById("mobile").style.display = "none";
				document.getElementById("error").style.display = "none";

				if (!createjs.Sound.initializeDefaultPlugins()) 
				{
					document.getElementById("error").style.display = "block";
					document.getElementById("content").style.display = "none";
					return;
				}

				if (createjs.Sound.BrowserDetect.isIOS || createjs.Sound.BrowserDetect.isAndroid || createjs.Sound.BrowserDetect.isBlackberry)
				{
					document.getElementById("mobile").style.display = "block";
					document.getElementById("content").style.display = "none";
					return;
				}

				canvas = document.getElementById("worlds");
				stage = new createjs.Stage(canvas);

				/*message = new createjs.Text("Loading", "bold 24px Arial", "#FFFFFF");
				message.maxWidth = 1000;
				message.textAlign = "center";
				message.x = canvas.width / 2;
				message.y = canvas.height / 2;
				stage.addChild(message);
				stage.update();*/

				manifest = [
					{src:"./img/planet.png", id:"planet"},
					{src:"./img/tube.png", id:"tube"}
				];

				loader = new createjs.LoadQueue(false);
				loader.addEventListener("complete", handleComplete);
				loader.loadManifest(manifest);
			}

			function handleComplete(event)
			{
				img_planet = loader.getResult("planet");
				img_tube = loader.getResult("tube");

				player = new Player();
				player.x = 50;
				player.y = 50;

				ss_planet = new createjs.SpriteSheet({
					images: [img_planet],
					frames: { width: PLANET_SIZE, height: PLANET_SIZE },
					animations: { alive: [0], dead: [1] }	//TODO add "change"
				});

				ss_tube = new createjs.SpriteSheet({
					images: [img_tube],
					frames: { width: TUBE_W, height: TUBE_H },
					animations: { begin: [0], end: [3], free: [1], busy: [2] }
				});

				deadPlanet = new createjs.Sprite(ss_planet, "dead");
				deadPlanet.x = PLANET_OFFSET;
				deadPlanet.y = canvas.height/2 - PLANET_SIZE/2;

				targetPlanet = new createjs.Sprite(ss_planet, "alive");
				targetPlanet.x = canvas.width - (PLANET_SIZE + PLANET_OFFSET);
				targetPlanet.y = canvas.height/2 - PLANET_SIZE/2;

				array_tube = new Array(10);
				array_tube[0] = new createjs.Sprite(ss_tube, "begin");
				array_tube[0].x = PLANET_OFFSET + PLANET_SIZE - TUBE_OFFSET;
				array_tube[0].y = canvas.height/2 - TUBE_H/2;
				array_tube[14] = new createjs.Sprite(ss_tube, "end");
				array_tube[14].x = canvas.width - (TUBE_W + PLANET_OFFSET + PLANET_SIZE - TUBE_OFFSET);
				array_tube[14].y = canvas.height/2 - TUBE_H/2;

				for(var i = 1; i < 14; ++i)
				{
					array_tube[i] = new createjs.Sprite(ss_tube, "free");
					array_tube[i].x = PLANET_OFFSET + PLANET_SIZE - TUBE_OFFSET + TUBE_W*i;
					array_tube[i].y = canvas.height/2 - TUBE_H/2;
					stage.addChild(array_tube[i]);
				}

				stage.addChild(player);
				stage.addChild(deadPlanet);
				stage.addChild(targetPlanet);
				stage.addChild(array_tube[0]);
				stage.addChild(array_tube[14]);
				stage.update();
			}
		</script>
		<style type="text/css">
			#content {
				user-select: none;
				background-color:#000000;
				width: 800px;
				height: 600px;
			}
		</style>
	</head>
	<body onLoad="init();">
		<div id="content">
			<canvas id="worlds" width="800" height="600"></canvas>
		</div>

		<!-- TODO make links! -->
		<div id="error">
			<h1>Oops!</h1>
			<p>SoundJS is not currently supported in your browser. Try to use Chrome.</p>
		</div>

		<div id="mobile">
			<h1>Oops!</h1>
			<p>Mobile devices isn't supported...</p>
		</div>
	</body>
</html>